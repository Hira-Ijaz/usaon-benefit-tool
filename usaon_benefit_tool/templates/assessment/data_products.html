{% extends 'assessment/base.html' %}
{% from 'bootstrap5/form.html' import render_form %}
{% from 'bootstrap5/utils.html' import render_icon %}
{% from 'macros/buttons.j2' import delete_button_htmx, create_button %}
{% from 'macros/javascript_highcharts.j2' import display_sankey %}

{% block content %}
  {{super()}}

  <h3>Data products</h3>

  <div class="two-columns">
    <div>
      <table>
        <tr>
          <th rowspan="2">Name</th>
          <th colspan="4">Related Observing Systems</th>
        </tr>
        <tr>
          <th>Name</th>
          <th>Performance Rating</th>
          <th>Criticality Rating</th>
          <th>Edit Relationships</th>
        </tr>
        {% for data_product in assessment.data_products %}
          <tr>
            <td>{{data_product.short_name}}
              {{delete_button_htmx(
                'assessment.data_product.delete',
                'Delete object',
                assessment_id=assessment.id,
                assessment_data_product_id=data_product.id,
              )}}
            </td>
            <td>
              {% if not data_product.input_relationships %}
                None
                <br />
              {% else %}
                <ul>
                  {% for input_relationship in data_product.input_relationships %}
                    <li>{{input_relationship.source.short_name}}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </td>
            <td>
              <ul>
                {% for input_relationship in data_product.input_relationships %}
                  <li>{{input_relationship.performance_rating}}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <ul>
                {% for input_relationship in data_product.input_relationships %}
                  <li>{{input_relationship.criticality_rating}}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              TODO!
              {#
              {{create_button(
                 'observing_system_data_product.view_response_observing_system_data_product_relationships',
                'New relationship',
                 assessment_id=assessment.id,
                 data_product_id=data_product.id,
              )}}
              {% for input_relationship in data_product.input_relationships %}
                <li>
                  {{delete_button(
                    'observing_system_data_product.delete_response_observing_system_data_product_relationship',
                    'Delete relationship',
                    assessment_id=assessment.id,
                    response_observing_system_data_product_id=input_relationship.id,
                  )}}
                </li>
              {% endfor %}
              #}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>

    {{ display_sankey(sankey_series, assessment=assessment) }}
  </div>


  {% if current_user.role_id in ['admin', 'respondent'] %}
    <h3>Add data product</h3>
    <form method="POST">
      {{render_form(form, button_map={'submit_button': 'primary'}) }}
    </form>
  {% endif %}

{% endblock %}
