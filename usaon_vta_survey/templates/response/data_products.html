{% extends 'response/base.html' %}
{% from 'bootstrap5/form.html' import render_form %}
{% from 'bootstrap5/utils.html' import render_icon %}

{% block content %}
  {% include 'includes/highcharts.html' %}

  {{super()}}

  <h3>Data products</h3>

  <div class="two-columns">
    <div>
      <table>
        <tr>
          <th rowspan="2">Name</th>
          <th colspan="4">Related Observing Systems</th>
        </tr>
        <tr>
          <th>Name</th>
          <th>Performance Rating</th>
          <th>Criticality Rating</th>
          <th>Edit Relationships</th>
        </tr>
        {% for data_product in response.data_products %}
          <tr>
            <td>{{data_product.short_name}}</td>
            <td>
              {% if not data_product.input_relationships %}
                None
                <br />
              {% endif %}
              <ul>
                {% for input_relationship in data_product.input_relationships %}
                  <li>{{input_relationship.observing_system.short_name}}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <ul>
                {% for input_relationship in data_product.input_relationships %}
                  <li>{{input_relationship.performance_rating}}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <ul>
                {% for input_relationship in data_product.input_relationships %}
                  <li>{{input_relationship.criticality_rating}}</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <a href="{{url_for(
                       'observing_system_data_product.view_response_observing_system_data_product_relationships',
                       survey_id=survey.id,
                       data_product_id=data_product.id,
                       )}}">
                {{render_icon('plus-circle-fill')}}
              </a>
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>

    {% if sankey_series == [] %}
      <div>Please input at least one dataproduct-to-observing systems relationship to display diagram</div>
    {% else %}
      <figure class="highcharts-figure">
        <div id="highcharts-container" />
      </figure>
    {% endif %}
  </div>


  {% if not current_user.role_id not in ['admin', 'respondent'] %}
    <h3>Add data product</h3>
    <form method="POST">
      {{render_form(form, button_map={'submit_button': 'primary'}) }}
    </form>
  {% endif %}

  <script>
    Highcharts.chart('highcharts-container', {
      chart: {
        type: 'sankey',
      },
      title: {
        text: 'U.S. AON Value Tree Analysis Diagram',
        style: {fontSize: '20px'},
      },
      accessibility: {
        description: 'Sankey plot for U.S. AON Value Tree',
        point: {
          valueDescriptionFormat: '{index}. {point.from} to {point.to}, {point.weight}.'
        }
      },
      series: [{
        keys: ['from', 'to', 'weight'],
        data: {{sankey_series | safe}},
      }]
    });
  </script>

{% endblock %}
